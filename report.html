<head>

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.3.0/milligram.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.4.2/handlebars.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<style>
	body {
		padding: 1em;
	}
	
	table.quarter_table {
		width: 25%;
		min-width: 10em;
	}
</style>

<script>
	var data = {
			"tx_data" : []
		};
		
	var graphColors = ['#2DA5F4', '#B5EAD7', '#FFFFD8', '#FF9AA2', '#FFDAC1'];
	
	function load() {
		
		loadChart(initHandlebars);
	}
	
	function initHandlebars() {
		Handlebars.registerHelper('ms_to_secs', function(ms) {
			return (ms / 1000).toFixed(1);
		});
		
		var source   = document.getElementById("tx_stats_template").innerHTML;
		var template = Handlebars.compile(source);
		var html 	 = template(data);		
		document.getElementById("tx_stats").innerHTML = html;
	}
	
	function loadChart(onLoadCallback) {
		
		var xhr = new XMLHttpRequest();		
		xhr.open("GET", "data.json", true);
		xhr.overrideMimeType("application/json");
		xhr.onload = function() {
			data = JSON.parse(xhr.responseText);
						
			var new_order = data.tx_data.find(function(element) { return element.tx_type === 'NewOrder'; });
			
			var tx_rt_series_array = [];
			data.tx_data.forEach(function(element) {
				tx_rt_series_array.push({
					name: element.tx_type,
					data: element.tx_rt_data.tx_rt_series,
					type: 'line'
				});
			});
			
			var tt_series_array = [];
			data.tx_data.forEach(function(element) {
				tt_series_array.push({
					name: element.tx_type,
					data: element.tx_rt_data.tt_series,
					type: 'line'
				});
			});
			

			var tx_rt_options = {
			  chart: {
				height: 380,
				width: "100%"
			  },
			  colors: graphColors,
			  series: tx_rt_series_array,
			  annotations: {
				xaxis: [
				  {
					x: new_order.tx_rt_data.tx_rt_mean,
					borderColor: "#2DA5F4",
					label: {
					  borderWidth: 0,
					  style: {
						color: "#2DA5F4",
						background: "rgba(255, 255, 255, 0.8)"
					  },
					  text: "Average = " + (new_order.tx_rt_data.tx_rt_mean / 1000).toFixed(1)
					}
				  },
				  {
					x: new_order.tx_rt_data.tx_rt_p90,
					borderColor: "#2DA5F4",					
					label: {
					  borderWidth: 0,
					  style: {
						color: "#2DA5F4",
						background: "rgba(255, 255, 255, 0.8)"
					  },
					  text: "90-th Percentile = " + (new_order.tx_rt_data.tx_rt_p90 / 1000).toFixed(1)
					}
				  }
				]
			  },
			  tooltip: {
				x: {
				  formatter: function(val) {
					return (val / 1000).toFixed(1);
				  }
				}
			  },
			  dataLabels: {
				enabled: true,
				style: {
					colors: ['#333']
				},
				offsetX: 0
			  },
			  legend: {
			    itemMargin: {
					horizontal: 10
				},
				onItemClick: {
					toggleDataSeries: true
				},
			  },
			  xaxis: {
			    title: {
					text: 'Transaction runtime, sec',
				},
				labels: {
					formatter: function (val) {
					  return (val / 1000).toFixed(1);
					}
				}
			  },
			  yaxis: {
				title: {
					text: 'Transaction count'
				}
			  }
			};
			
			var tt_options = {
			  chart: {
				height: 380,
				width: "100%"
			  },
			  colors: graphColors,
			  series: tt_series_array,
			  annotations: {
				xaxis: [
				  {
					x: new_order.tx_rt_data.tt_mean,
					borderColor: "#2DA5F4",
					label: {
					  borderWidth: 0,
					  style: {
						color: "#2DA5F4",
						background: "rgba(255, 255, 255, 0.8)"
					  },
					  text: "Mean Think Time = " + (new_order.tx_rt_data.tt_mean / 1000).toFixed(1)
					}
				  }
				]
			  },
			  tooltip: {
				x: {
				  formatter: function(val) {
					return (val / 1000).toFixed(1);
				  }
				}
			  },
			  dataLabels: {
				enabled: true,
				style: {
					colors: ['#333']
				},
				offsetX: 0
			  },
			  legend: {
			    itemMargin: {
					horizontal: 10
				},
				onItemClick: {
					toggleDataSeries: true
				},
			  },
			  xaxis: {
			    title: {
					text: 'Think time, sec',
				},
				labels: {
					formatter: function (val) {
					  return (val / 1000).toFixed(1);
					}
				}
			  },
			  yaxis: {
				title: {
					text: 'Transaction count'
				}
			  }
			};
			
			
			var tpm_options = {
			  chart: {
				height: 380,
				width: "100%"
			  },
			  colors: ['#2DA5F4'],
			  series: [
				{
				  name: "NewOrder tpmC",
				  data: new_order.throughput_data.tpm_series,
				  type: "line"
				},
				{
				  name: "NewOrder count",
				  data: new_order.throughput_data.tx_count_series,
				  type: "bar"
				}
				
			  ],
			  annotations: {
				xaxis: [
				  {
					x: new_order.throughput_data.steady_begin_time,
					borderColor: "#00E396",
					label: {
					  //borderColor: "#00E396",
					  borderWidth: 0,
					  style: {
						color: "#00E396",
						background: "rgba(255, 255, 255, 0.8)"
					  },
					  text: "Steady Started = " + (new_order.throughput_data.steady_begin_time / 1000).toFixed(0)
					}
				  },
				  {
					x: new_order.throughput_data.steady_end_time,
					borderColor: "#00E396",					
					label: {
					  //borderColor: "#00E396",
					  borderWidth: 0,
					  style: {
						color: "#00E396",
						background: "rgba(255, 255, 255, 0.8)"
					  },
					  text: "Steady Finished = " + (new_order.throughput_data.steady_end_time / 1000).toFixed(0)
					}
				  }
				]
			  },	
			  tooltip: {
				x: {
				  formatter: function(val) {
					return (val / 1000).toFixed(0);
				  }
				}
			  },
			  xaxis: {
				title: {
					text: 'Elapsed Time, sec'
				},
				labels: {
					formatter: function (val) {
					  return (val / 1000).toFixed(0);
					}
				}
			  },
			  yaxis: {
				title: {
					text: 'tpmC'
				}
			  }
			};


			var tx_rt_chart = new ApexCharts(
				document.querySelector("#tx_rt_chart"),
				tx_rt_options
			);

			tx_rt_chart.render();

			var tt_chart = new ApexCharts(
				document.querySelector("#tt_chart"),
				tt_options
			);

			tt_chart.render();

			tt_options
			
			var tpm_chart = new ApexCharts(
				document.querySelector("#tpm_chart"),
				tpm_options
			);

			tpm_chart.render();
			
			onLoadCallback();
		}
		xhr.send();
	}
</script>
</head>
<body onload="load();">
<div id="tx_stats"></div>

<h3>Transaction Response Time Frequency Distribution</h3>
<div id="tx_rt_chart"></div>
<div style="padding: 20px" >&nbsp;</div>
<h3>Think Time Frequency Distribution</h3>
<div id="tt_chart"></div>
<div style="padding: 20px" >&nbsp;</div>
<h3>Throughput</h3>
<div id="tpm_chart"></div>

<script id="tx_stats_template" type="text/x-handlebars-template">
<h3>Transaction Runtime Statistics</h3>
<p></p>
<table>
  <thead>
	<tr>
	  <th>Transaction Type</th>
	  <th>90-th Percentile, sec</th>
	  <th>Mean, sec</th>
	  <th>Transaction count</th>
	  <th>tpmC</th>
	</tr>
  </thead>
  
  <tbody>{{#each tx_data}}  
	<tr>
	  <td>{{tx_type}}</td>
	  <td>{{ms_to_secs tx_rt_data.tx_rt_p90}}</td>
	  <td>{{ms_to_secs tx_rt_data.tx_rt_mean}}</td>
	  <td>{{tx_rt_data.tx_rt_tx_count}}</td>
	  <td>{{tx_rt_data.tpmc}}</td>
	</tr>{{/each}}
  </tbody>
</table>
<h3>Total</h3>
<table class="quarter_table">
	<tbody>
		<tr>
			<td scope="row">tpmC</td>
			<td>{{total_tpmc}}</td>
		</tr>
		<tr>
			<td scope="row">Transaction count</td>
			<td>{{total_tx_count}}</td>
		</tr>
		<tr>
			<td scope="row">Terminal count</td>
			<td>{{terminal_count}}</td>
		</tr>
	</tbody>
</table>

</script>
</body>